# 币安API测试脚本使用说明

## 📋 脚本功能

测试币安合约API的完整交易流程：
1. ✅ 查询账户余额
2. ✅ 设置逐仓模式和杠杆
3. ✅ 开仓BTC多单（约$1）
4. ✅ 查询持仓信息
5. ✅ 平仓
6. ✅ 计算盈亏和手续费

## 🚀 快速开始

### 第一步：配置测试网API密钥

1. 访问 [币安测试网](https://testnet.binancefuture.com/)
2. 登录（如果没有账号会自动创建）
3. 点击右上角用户名 → API Management
4. 创建新的API密钥

### 第二步：配置.env文件

在项目根目录的 `.env` 文件中添加：

```bash
# 测试网API密钥（安全，使用测试币）
BINANCE_TESTNET_API_KEY=你的测试网API_KEY
BINANCE_TESTNET_SECRET_KEY=你的测试网SECRET_KEY
```

### 第三步：领取测试币

1. 在测试网首页点击 **Get Test Funds**
2. 选择 USDT，点击领取
3. 通常会获得 10,000 USDT 测试币

### 第四步：运行测试

```bash
# 方式1：使用npm脚本（推荐）
npm run test:api

# 方式2：直接运行
npx ts-node -r tsconfig-paths/register scripts/test_binance_api.ts
```

## 📊 预期输出

```
🧪 币安测试网API功能测试

═══════════════════════════════════════════════════════════════════════════════
✅ API密钥配置检查通过

📋 测试参数:
  交易对: BTCUSDT
  保证金: $1
  杠杆: 10x
  预计仓位价值: $10

📊 [1/6] 查询账户信息...
  可用余额: 10000.00 USDT
  ✅ 余额充足

💰 [2/6] 获取BTC当前价格...
  当前价格: $95234.50
  计算数量: 0.001 BTC (价值约$95.23)

⚙️  [3/6] 配置交易参数...
  ✅ 已设置为逐仓模式
  ✅ 杠杆已设置为 10x

🚀 [4/6] 开仓做多...
  下单: BUY 0.001 BTC @ 市价
  ✅ 开仓成功!
  订单ID: 123456789
  状态: FILLED
  成交数量: 0.001 BTC
  成交均价: $95234.50

📍 [5/6] 查询当前持仓...
  ✅ 持仓信息:
     仓位: 0.001 BTC
     入场价: $95234.50
     标记价: $95235.20
     未实现盈亏: +$0.0007
     杠杆: 10x

🔚 [6/6] 平仓...
  下单: SELL 0.001 BTC @ 市价
  ✅ 平仓成功!
  订单ID: 123456790
  状态: FILLED
  成交数量: 0.001 BTC
  成交均价: $95235.20

💹 交易结果:
═══════════════════════════════════════════════════════════════════════════════
  入场价格: $95234.50
  出场价格: $95235.20
  价格变化: +$0.70 (+0.0007%)
  实际盈亏: +$0.0070
  预估手续费: -$0.0762
  净盈亏: -$0.0692
═══════════════════════════════════════════════════════════════════════════════

🔍 最终验证...
  ✅ 确认: 持仓已完全平仓
  初始余额: 10000.00 USDT
  最终余额: 9999.93 USDT
  余额变化: -0.0692 USDT

═══════════════════════════════════════════════════════════════════════════════
✅ 测试完成！API功能正常
═══════════════════════════════════════════════════════════════════════════════

📝 测试总结:
  • 开仓订单: 123456789 (FILLED)
  • 平仓订单: 123456790 (FILLED)
  • 交易对: BTCUSDT
  • 数量: 0.001 BTC
  • 杠杆: 10x (逐仓)
  • 净盈亏: -$0.0692
  • 余额变化: -0.0692 USDT
```

## ⚠️ 常见问题

### Q1: 提示"缺少API密钥配置"

**解决方法**：
```bash
# 检查.env文件是否存在
ls -la .env

# 确认配置正确
cat .env | grep BINANCE_TESTNET
```

应该看到：
```
BINANCE_TESTNET_API_KEY=你的密钥
BINANCE_TESTNET_SECRET_KEY=你的密钥
```

### Q2: 提示"余额不足"

**解决方法**：
1. 访问 [测试网](https://testnet.binancefuture.com/)
2. 点击右上角 **Get Test Funds**
3. 领取测试USDT

### Q3: 提示"Invalid API-key, IP, or permissions"

**可能原因**：
1. API密钥复制错误（有多余空格）
2. 测试网和实盘API密钥混淆
3. API密钥权限不足

**解决方法**：
1. 重新复制API密钥，确保没有空格
2. 确认使用的是测试网API密钥
3. 在测试网重新创建API密钥，勾选"Enable Futures"权限

### Q4: 订单被拒绝 "Margin is insufficient"

**原因**: 逐仓模式下，每个仓位的保证金独立计算

**解决方法**: 确保测试网账户有足够余额（至少10 USDT）

### Q5: 显示"未找到持仓"

**可能原因**：
1. 订单未完全成交
2. 持仓更新有延迟
3. 已被强制平仓（价格剧烈波动）

**解决方法**: 登录测试网Web界面手动检查持仓

## 🔒 安全提示

### ✅ 测试网特点
- **完全安全** - 使用虚拟测试币
- **无真实风险** - 不会影响真实资金
- **可重复测试** - 可以无限次测试

### ⚠️ 切换实盘前必读

**本脚本默认使用测试网**，如需切换到实盘：

1. 修改脚本第27行：
```typescript
const trading_api = new BinanceFuturesTradingAPI(api_key, secret_key, false);
//                                                                       ^^^^^ 改为false
```

2. 配置实盘API密钥：
```bash
BINANCE_API_KEY=你的实盘API_KEY
BINANCE_SECRET_KEY=你的实盘SECRET_KEY
```

3. **⚠️ 极其重要**：
   - 只用完全能承受亏损的资金
   - 先在测试网完成至少10次成功测试
   - 实盘测试从最小金额开始（$1-$5）
   - 确认API权限只开启"合约交易"，关闭"提现"

## 📚 相关文档

- [币安合约API文档](https://binance-docs.github.io/apidocs/futures/cn/)
- [测试网地址](https://testnet.binancefuture.com/)
- [订单执行器源码](../src/trading/order_executor.ts)
- [币安API封装](../src/api/binance_futures_trading_api.ts)

## 💡 下一步

测试通过后，可以：

1. **运行回测**：
```bash
npm run backtest
```

2. **启动实盘交易**（测试网）：
```bash
npx ts-node -r tsconfig-paths/register scripts/run_live_trading_50usd.ts
```

3. **查看更多测试脚本**：
```bash
ls scripts/test_*.ts
```

---

**记住：充分测试是成功交易的基础！** 🚀

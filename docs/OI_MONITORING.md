# OI持仓量监控模块文档

## 📋 功能概述

实时监控币安U本位合约的持仓量（Open Interest）变化，自动检测异动并记录到数据库，为量化交易提供数据支持。

---

## 🎯 核心功能

### 1. 数据采集
- **采集频率**: 1分钟一次（全天24小时）
- **监控币种**: 币安返回的全部合约币种
- **采集内容**:
  - 持仓量（OI）
  - 标记价格
  - 资金费率
  - 下次资金费时间

### 2. 异动检测

#### 检测阈值
根据不同时间窗口检测OI变化：

| 时间窗口 | 阈值 | 说明 |
|---------|------|------|
| 1分钟 | 3% | 短期快速变化 |
| 2分钟 | 3% | 短期快速变化 |
| 5分钟 | 3% | 中期趋势 |
| 15分钟 | 10% | 长期趋势 |

**触发条件**: OI变化率 ≥ 阈值

**严重程度分级**:
- **Low**: 变化 < 15%
- **Medium**: 15% ≤ 变化 < 30%
- **High**: 变化 ≥ 30%

#### 检测流程详解

**每1分钟轮询周期**:

1️⃣ **批量获取OI数据**
   ```
   请求: GET /fapi/v1/openInterest (批量，~530个币种)
   返回: { symbol, openInterest, time }
   耗时: ~13秒
   ```

2️⃣ **批量获取价格和资金费率**
   ```
   请求: GET /fapi/v1/premiumIndex (批量，~530个币种)
   返回: { symbol, markPrice, lastFundingRate, nextFundingTime }
   耗时: ~3秒
   ```

3️⃣ **存储快照数据**
   - 写入日期分表: `open_interest_snapshots_YYYYMMDD`
   - 包含: OI + 价格 + 资金费率

4️⃣ **异动检测** (对每个币种，检测4个时间窗口)
   - 查询历史快照: 从分表中获取N分钟前的数据
   - 计算变化率: `(当前OI - 历史OI) / 历史OI * 100`
   - 判断是否超过阈值

   **示例**:
   ```
   当前时间: 14:05:00, OI: 1,000,000
   查找 14:00:00 (5分钟前), OI: 950,000
   变化率: (1,000,000 - 950,000) / 950,000 = 5.26%
   结果: 超过5分钟阈值(3%) → 触发异动 ✓
   ```

5️⃣ **去重判断**
   - 检查Redis缓存: 该币种同周期是否有近期异动
   - 对比变化率: 与上次异动相比，变化差异 < 2% 则跳过
   - 目的: 避免连续记录相似的异动

6️⃣ **获取附加数据** (仅异动币种)

   **市场情绪数据**:
   ```
   请求: GET /futures/data/topLongShortPositionRatio (大户持仓多空比)
   请求: GET /futures/data/topLongShortAccountRatio (大户账户多空比)
   请求: GET /futures/data/globalLongShortAccountRatio (全市场多空比)
   请求: GET /futures/data/takerlongshortRatio (主动买卖比)
   ```

   **已有数据** (无需额外请求):
   - 价格变化: 从步骤2的数据计算
   - 资金费率变化: 从历史快照对比

7️⃣ **保存异动记录**
   - 写入表: `oi_anomaly_records`
   - 包含: OI变化 + 价格变化 + 资金费率变化 + 市场情绪
   - 更新Redis缓存: 用于下次去重判断

### 3. 数据存储

#### OI快照数据（历史数据）
- **存储位置**: 日期分表 `open_interest_snapshots_YYYYMMDD`
- **分表规则**: 按北京时间日期分表
- **保留时间**: 20天
- **字段**: symbol, open_interest, mark_price, funding_rate, snapshot_time

#### 异动记录（核心数据）
- **存储位置**: `oi_anomaly_records` 表
- **去重机制**: 变化率差异 < 2% 不重复记录
- **包含数据**:
  - OI变化（before/after/变化率）
  - 价格变化（before/after/变化率）
  - **资金费率变化**（before/after/变化率）✨
  - 市场情绪数据（多空比等）

---

## 🔧 配置说明

### 数据库配置表 `oi_monitoring_config`

```sql
-- 轮询间隔（毫秒）
polling_interval_ms = 60000  -- 1分钟

-- 非交易时段配置（已禁用，全天1分钟）
off_hours_config = {"start":0,"end":0,"interval_ms":60000}

-- 异动阈值
thresholds = {"60":3,"120":3,"300":3,"900":10}

-- 去重阈值（百分比）
dedup_change_diff_threshold = 2

-- 严重程度阈值
severity_thresholds = {"high":30,"medium":15}
```

### 修改配置
```sql
-- 示例：修改5分钟阈值为5%
UPDATE oi_monitoring_config
SET config_value = '{"60":3,"120":3,"300":5,"900":10}'
WHERE config_key = 'thresholds';
```

配置会在2小时内自动重新加载，或重启服务立即生效。

---

## 📊 数据流程

```
┌─────────────┐
│ 币安API采集  │ 每1分钟
│ 530个币种    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 存储快照数据 │ 日期分表（北京时间）
│ OI + 价格    │ open_interest_snapshots_20251113
│ + 资金费率   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 异动检测     │ 4个时间窗口（1m/2m/5m/15m）
│ 对比历史数据 │ 超过阈值 → 触发异动
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 去重判断     │ 变化差异 < 2% 跳过
│ Cache优先    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 保存异动记录 │ oi_anomaly_records
│ 包含附加数据 │ 价格+资金费率+市场情绪
└─────────────┘
```

---

## 🌟 资金费率功能说明

### 作用
**仅作为附加数据**，不影响异动判断。当检测到OI异动时，自动记录当时的资金费率状态。

### 数据内容
- `funding_rate_before` - 变化前的资金费率
- `funding_rate_after` - 变化后的资金费率
- `funding_rate_change` - 变化量
- `funding_rate_change_percent` - 变化百分比

### 应用场景
- 分析OI暴涨时的市场情绪（资金费率高 → 多头过热）
- 判断OI变化的真实性（资金费率同向变化 → 真实需求）
- 识别轧空/爆仓事件（OI与资金费率反向 → 被动平仓）

---

## 📡 API接口

### 1. 查询异动记录
```http
GET /api/oi/anomalies
Query参数:
  - symbol: 币种（可选，如 BTCUSDT）
  - severity: 严重程度（可选，low/medium/high）
  - limit: 返回数量（默认100）
  - hours: 时间范围（默认24小时）
```

### 2. 查询币种异动历史
```http
GET /api/oi/anomalies/:symbol
Path参数:
  - symbol: 币种名称（如 BTCUSDT）
Query参数:
  - hours: 时间范围（默认24小时）
```

### 3. 查询OI曲线数据
```http
GET /api/oi/curve
Query参数:
  - symbol: 币种（必填，如 BTCUSDT）
  - date: 日期（必填，格式 YYYY-MM-DD）

返回: 该币种在指定日期的所有OI数据点
```

### 4. 查询最近异动
```http
GET /api/oi/recent-anomalies
Query参数:
  - limit: 返回数量（默认50）

返回: 按时间倒序的最近异动记录
```

---

## ⚠️ 重要注意事项

### 1. 时区处理
- **数据库TIMESTAMP**: 存储UTC时间
- **分表逻辑**: 按北京时间（UTC+8）日期分表
- **查询逻辑**: 自动转换为北京时间
- **结论**: 开发者无需关心时区，系统自动处理 ✅

### 2. 数据保留
- **OI快照**: 20天自动清理（DailyTableManager）
- **异动记录**: 永久保留

### 3. API权重
- **每次轮询**: ~530权重（530个币种 × 1权重）
- **1分钟限制**: 2400权重
- **占用率**: 22%，安全范围内 ✅

### 4. 去重机制
- **目的**: 避免相同异动重复记录
- **判断**: 同币种同周期，变化率差异 < 2% 则跳过
- **缓存**: 优先使用Redis缓存，提高性能

### 5. 分表查询
- **跨天查询**: 自动UNION多个日期表
- **降级策略**: 日期表不存在时，降级到原始表
- **性能**: 单表查询 < 100ms

---

## 🔍 故障排查

### 1. 异动检测失败
**检查项**:
- [ ] 是否有足够的历史数据（至少5-15分钟）
- [ ] 配置表中的阈值是否合理
- [ ] Redis缓存是否正常
- [ ] 日志中是否有错误信息

### 2. 数据采集停止
**检查项**:
- [ ] OI轮询服务是否运行
- [ ] 币安API连接是否正常
- [ ] MySQL连接池是否耗尽
- [ ] 查看日志: `[OIPolling]` 相关信息

### 3. 分表查询失败
**检查项**:
- [ ] 日期表是否存在
- [ ] 查询时间范围是否正确
- [ ] 原始表作为降级是否可用

### 日志关键字
```bash
# 采集日志
[OIPolling] Polling cycle completed

# 异动检测
[OIPolling] Detected X anomalies

# 保存记录
[OIPolling] Saved X anomaly records

# 错误
[ERROR] [OIPolling] Failed to...
```

---

## 📈 性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| 采集周期 | 1分钟 | 全天24小时 |
| 单次采集时长 | ~13秒 | 530个币种并发请求 |
| 异动检测耗时 | <1秒 | 基于内存计算 |
| 数据库写入 | <100ms | 批量插入优化 |
| API响应时间 | <200ms | 包含查询+格式化 |

---

## 🚀 未来优化方向

- [ ] 支持自定义异动阈值（按币种）
- [ ] 增加Webhook通知功能
- [ ] 优化去重算法（更精准）
- [ ] 添加异动预测功能（ML）
- [ ] 支持更多时间窗口（30m/1h/4h）

---

## 📝 更新日志

### v1.2.0 (2025-11-13)
- ✨ 新增资金费率数据记录
- ✨ 取消非交易时段降频，全天1分钟采集
- 🐛 修复跨表查询时区问题
- 🐛 修复北京时间分表逻辑

### v1.1.0 (2025-11-12)
- ✨ 实现日期分表存储（按北京时间）
- ✨ 添加市场情绪数据收集
- 🔧 优化异动去重机制

### v1.0.0 (2025-09-28)
- 🎉 初始版本发布
- ✨ 基础OI监控功能
- ✨ 异动检测和记录

---

**维护人员**: Trading Master Team
**最后更新**: 2025-11-13

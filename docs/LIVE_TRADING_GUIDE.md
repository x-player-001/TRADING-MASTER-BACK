# 实盘交易使用指南

## 📋 概述

本系统实现了完整的**OI异动驱动的自动交易**功能，支持三种交易模式：

1. **PAPER** - 纸面交易（模拟，无风险）
2. **TESTNET** - 币安测试网（模拟资金，真实API）
3. **LIVE** - 实盘交易（⚠️ 真实资金，谨慎使用）

## 🚀 快速开始

### 1. 运行纸面交易（推荐先测试）

```bash
npm run trade
```

这将启动：
- ✅ OI监控服务（实时监控币安合约持仓量）
- ✅ 信号生成引擎（基于OI异动生成交易信号）
- ✅ 策略过滤引擎（避免追高，只做早期启动）
- ✅ 风险管理引擎（5:1盈亏比，4%止损，20%止盈）
- ✅ 纸面交易执行器（模拟订单）

### 2. 切换到测试网

编辑 `scripts/run_live_trading.ts`:

```typescript
mode: TradingMode.TESTNET,  // 改为测试网
```

配置测试网API（在`.env`中）:
```bash
BINANCE_TEST_API_KEY=your_testnet_api_key
BINANCE_TEST_API_SECRET=your_testnet_api_secret
BINANCE_TEST_API_BASE_URL=https://testnet.binancefuture.com
```

获取测试网API: https://testnet.binancefuture.com/

### 3. 实盘交易（⚠️ 谨慎）

**强烈建议先在纸面交易和测试网运行至少1周，验证策略稳定性后再使用实盘！**

```typescript
mode: TradingMode.LIVE,  // ⚠️ 真实资金
```

## 📊 策略配置

当前策略使用**回测优化后的最佳参数**：

### 核心参数
```typescript
止损: 4%
止盈: 20%
盈亏比: 5:1
移动止损: 3%回撤
持仓时间: 最多30分钟
```

### 信号过滤
```typescript
最小信号分数: 7分（满分10分）
最小置信度: 70%
OI变化: ≥3%
大户多空比: 做多需>1.2，做空需<0.8
```

### 风险控制
```typescript
单笔仓位: 5%资金
最大持仓: 3个
杠杆: 1-3x（根据信号强度）
每日亏损限制: 10%
连续亏损限制: 5次
```

### 避免追高逻辑 ✅
1. **晚期狂欢拒绝**: OI>20% 或 价格>15%
2. **背离危险拒绝**: OI>8% 但 价格<1%
3. **大户反向拒绝**: 做多时大户多空比<1.0
4. **早期启动优先**: OI 5-15%, 价格 2-6%

## 📈 回测表现

基于最近7天历史数据的回测结果：

| 指标 | 数值 |
|------|------|
| 总收益率 | **+7.97%** |
| 胜率 | **45.9%** |
| 盈亏比 | **2.04:1** |
| 最大回撤 | **4.67%** |
| 交易次数 | **61笔** |
| 平均持仓 | **23.9分钟** |

**预估年化收益**: ~415%（假设收益率保持稳定）

## 🎯 工作流程

```
OI监控 → 异动检测 → 信号生成 → 策略过滤 → 风险检查 → 执行开仓
                                                           ↓
  ← 平仓记录 ← 订单执行 ← 触发平仓 ← 持仓监控 ← 止损/止盈/超时
```

### 详细流程

1. **OI监控服务**
   - 每60秒轮询一次所有币种的持仓量
   - 检测5分钟、15分钟、1小时的OI变化
   - 当OI变化≥3%时触发异动事件

2. **信号生成引擎**
   - 接收OI异动事件
   - 计算评分（OI分+价格分+情绪分）
   - 检查避免追高条件
   - 生成交易信号

3. **策略过滤引擎**
   - 检查信号分数≥7
   - 检查置信度≥70%
   - 检查价格OI一致性
   - 检查大户多空比

4. **风险管理引擎**
   - 检查持仓数量限制
   - 检查每日亏损限制
   - 检查连续亏损限制
   - 计算仓位大小和杠杆

5. **订单执行器**
   - 执行开仓订单
   - 设置止损止盈
   - 创建持仓记录

6. **持仓监控**
   - 每10秒检查一次所有持仓
   - 检查止损、止盈、超时
   - 更新移动止损
   - 触发时自动平仓

## ⚠️ 风险提示

### 1. 策略风险
- 小市值币波动大，可能出现剧烈回撤
- OI异动可能是虚假信号（假突破）
- 极端行情下止损可能滑点

### 2. 技术风险
- 网络延迟可能导致错过最佳入场点
- API限速可能影响订单执行
- 服务器宕机可能无法及时平仓

### 3. 市场风险
- 黑天鹅事件（闪崩、极端行情）
- 交易所维护导致无法交易
- 流动性不足导致无法平仓

### 4. 资金管理建议
- ✅ 只投入可承受损失的资金
- ✅ 初期使用小额资金测试
- ✅ 设置严格的每日亏损限制
- ✅ 定期提取利润，降低在险资金
- ❌ 不要盲目加仓
- ❌ 不要在亏损后急于翻本

## 📊 监控和日志

### 实时状态显示
运行时每30秒自动打印：
- 运行状态
- 当前持仓情况
- 交易统计（胜率、盈亏）
- 当前余额

### 日志查看
所有交易决策和执行都会记录到日志：
```bash
# 查看实时日志
tail -f logs/trading.log
```

## 🛠️ 故障排除

### 无法启动
1. 检查MySQL和Redis是否运行
2. 检查`.env`配置是否正确
3. 检查端口3000是否被占用

### 没有交易信号
1. 检查OI监控是否正常运行
2. 检查是否有异动（OI变化≥3%）
3. 检查信号过滤是否过于严格

### 测试网订单失败
1. 检查测试网API密钥是否正确
2. 检查测试网账户是否有足够余额
3. 检查API权限是否包含交易

## 📝 最佳实践

1. **循序渐进**
   - 第1周: 纸面交易观察
   - 第2周: 测试网小额测试
   - 第3周: 实盘极小额测试
   - 第4周+: 逐步增加资金

2. **持续优化**
   - 定期查看交易记录
   - 分析亏损原因
   - 调整策略参数
   - 优化信号过滤

3. **风险控制**
   - 严格遵守止损
   - 不要手动干预
   - 保持冷静，避免情绪化
   - 亏损后休息，不要连续交易

## 📚 相关文档

- [回测报告](./BACKTEST_RESULTS.md)
- [策略说明](./STRATEGY_GUIDE.md)
- [API文档](./API_REFERENCE.md)

## ❓ 常见问题

**Q: 为什么没有交易？**
A: 策略非常严格，只做高质量信号。可能需要等待合适的OI异动。

**Q: 可以修改参数吗？**
A: 可以，但建议先回测验证。修改后重新运行`npm run backtest`测试。

**Q: 如何停止交易？**
A: 按`Ctrl+C`，系统会询问是否平掉所有持仓后优雅退出。

**Q: 支持哪些币种？**
A: 所有币安U本位合约，系统会自动监控所有币种的OI异动。

**Q: 盈亏比5:1是否太激进？**
A: 回测显示45.9%胜率下，5:1盈亏比能获得正收益。可根据实际情况调整。

---

**⚠️ 免责声明**: 本系统仅供学习交流使用，不构成投资建议。加密货币交易存在高风险，请谨慎使用真实资金。

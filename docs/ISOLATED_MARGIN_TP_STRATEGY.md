# é€ä»“æ¨¡å¼åˆ†æ‰¹æ­¢ç›ˆç­–ç•¥æ–‡æ¡£

## ğŸ“‹ ç­–ç•¥æ¦‚è¿°

**é€ä»“ (Isolated Margin) æ¨¡å¼**ï¼šæ— æ­¢æŸçº¿ï¼Œå¼€ä»“é‡‘é¢å³ä¸ºå¯æ¥å—çš„æœ€å¤§æŸå¤±ã€‚

ç»“åˆ**åˆ†æ‰¹æ­¢ç›ˆ**å’Œ**åŠ¨æ€è·Ÿè¸ªæ­¢ç›ˆ**ï¼Œåœ¨é«˜æ³¢åŠ¨ç¯å¢ƒä¸‹é¿å…è¢«æ­¢æŸæ‰«å‡ºï¼ŒåŒæ—¶æ•æ‰å¤§è¡Œæƒ…ã€‚

---

## ğŸ¯ æ ¸å¿ƒç­–ç•¥

### ä»“ä½åˆ†é…

| æ‰¹æ¬¡ | ä»“ä½æ¯”ä¾‹ | æ­¢ç›ˆç›®æ ‡ | ç±»å‹ | è¯´æ˜ |
|------|----------|----------|------|------|
| ç¬¬1æ‰¹ | 40% | **+8%** | å›ºå®šæ­¢ç›ˆ | å¿«é€Ÿå›æœ¬ï¼Œé™ä½å¿ƒç†å‹åŠ› |
| ç¬¬2æ‰¹ | 30% | **+14%** | å›ºå®šæ­¢ç›ˆ | ä¸­æœŸæ”¶ç›Šï¼Œç¨³å®šç›ˆåˆ© |
| ç¬¬3æ‰¹ | 30% | æ— ä¸Šé™ | è·Ÿè¸ªæ­¢ç›ˆ | æ•æ‰å¤§è¡Œæƒ…ï¼Œ30%å›è°ƒè§¦å‘ |

### é£é™©æ§åˆ¶

- **æ­¢æŸ**: âŒ **æ— æ­¢æŸçº¿**
- **ä¿è¯é‡‘æ¨¡å¼**: é€ä»“ (Isolated)
- **æœ€å¤§æŸå¤±**: å¼€ä»“æœ¬é‡‘ 100%
- **é€‚ç”¨åœºæ™¯**:
  - âœ… é«˜æ³¢åŠ¨å¸ç§ï¼ˆé¿å…è¢«æ­¢æŸæ‰«å‡ºï¼‰
  - âœ… å¼ºè¶‹åŠ¿ä¿¡å·ï¼ˆé«˜è¯„åˆ† 7-10åˆ†ï¼‰
  - âœ… æœ‰æ¸…æ™°æ”¯æ’‘ä½çš„å¼‚åŠ¨

---

## ğŸ“Š ç­–ç•¥ä¼˜åŠ¿

### âœ… ä¼˜ç‚¹

1. **é¿å…å‡çªç ´æ­¢æŸ**
   - ä¸ä¼šå› çŸ­æœŸæ³¢åŠ¨è¢«æ­¢æŸæ‰«å‡º
   - é€‚åˆé«˜æ³¢åŠ¨åŠ å¯†è´§å¸å¸‚åœº

2. **æ•æ‰å®Œæ•´è¡Œæƒ…**
   - è·Ÿè¸ªæ­¢ç›ˆå¯æ•æ‰ +20%ã€+30% ç”šè‡³æ›´é«˜æ”¶ç›Š
   - æµ‹è¯•æ¡ˆä¾‹ï¼šæœ€é«˜æ¶¨è‡³ +31.9%ï¼Œæœ€ç»ˆæ­¢ç›ˆ +20.88%

3. **é£é™©å¯æ§**
   - é€ä»“æ¨¡å¼éš”ç¦»é£é™©ï¼Œä¸å½±å“å…¶ä»–ä»“ä½
   - ç¬¬ä¸€æ‰¹ 40% @ +8% å¿«é€Ÿå›æœ¬ï¼Œé™ä½æ•´ä½“é£é™©æš´éœ²

4. **çµæ´»åº”å¯¹å¤§è¡Œæƒ…**
   - ç¬¬äºŒæ‰¹ 30% @ +14% é”å®šä¸­æœŸæ”¶ç›Š
   - ç¬¬ä¸‰æ‰¹ 30% è·Ÿè¸ªæ­¢ç›ˆæ•æ‰é»‘å¤©é¹…

### âš ï¸ é£é™©æç¤º

1. **æœ€å¤§æŸå¤± 100%**
   - ä»·æ ¼å¯èƒ½è·Œè‡³ 0ï¼ŒæŸå¤±å…¨éƒ¨æœ¬é‡‘
   - **å¿…é¡»ä¸¥æ ¼æ§åˆ¶å•ç¬”å¼€ä»“é‡‘é¢**

2. **ä»“ä½ç®¡ç†è‡³å…³é‡è¦**
   ```
   å»ºè®®é…ç½®ï¼š
   - å•ç¬”å¼€ä»“ï¼šâ‰¤ æ€»èµ„é‡‘çš„ 2%
   - æœ€å¤šåŒæ—¶æŒä»“ï¼š3-5 ä¸ª
   - æ€»é£é™©æš´éœ²ï¼šâ‰¤ æ€»èµ„é‡‘çš„ 10%
   ```

3. **é€‚ç”¨ä¿¡å·è¦æ±‚**
   - å¿…é¡»æ˜¯é«˜è¯„åˆ†ä¿¡å·ï¼ˆ7åˆ†ä»¥ä¸Šï¼‰
   - OI å’Œä»·æ ¼åŒå‘ï¼ˆé¿å…èƒŒç¦»ï¼‰
   - æœ‰æ˜ç¡®çš„å¸‚åœºæƒ…ç»ªæ”¯æ’‘

---

## ğŸ§ª å›æµ‹æ¡ˆä¾‹

### æµ‹è¯•åœºæ™¯

**å…¥åœº**: BTCUSDT @ 91,000
**åˆå§‹ä»“ä½**: 1.0 BTC (ä»·å€¼ $91,000)
**ä¿¡å·è¯„åˆ†**: 9.97/10 (STRONG)

### ä»·æ ¼èµ°åŠ¿

| ä»·æ ¼ | å˜åŒ– | åŠ¨ä½œ | å‰©ä½™ä»“ä½ |
|------|------|------|----------|
| 91,000 | 0% | å¼€ä»“ | 1.0 BTC |
| 98,280 | +8.0% | **ç¬¬1æ‰¹æ­¢ç›ˆ** | 0.6 BTC |
| 105,000 | +15.4% | **ç¬¬2æ‰¹æ­¢ç›ˆ** | 0.3 BTC |
| 120,000 | +31.9% | è·Ÿè¸ªæœ€é«˜ç‚¹ | 0.3 BTC |
| 110,000 | +20.9% | **è·Ÿè¸ªæ­¢ç›ˆè§¦å‘** | 0 BTC |

### æ”¶ç›Šå¯¹æ¯”

| ç­–ç•¥ | æ”¶ç›Šé‡‘é¢ | æ”¶ç›Šç‡ | è¯´æ˜ |
|------|----------|--------|------|
| å•ä¸€æ­¢ç›ˆ @ +8% | $7,280 | +8.00% | âŒ è¿‡æ—©ç¦»åœº |
| å•ä¸€æ­¢ç›ˆ @ +14% | $12,740 | +14.00% | âš ï¸ é£é™©é«˜ |
| **åˆ†æ‰¹+è·Ÿè¸ªç­–ç•¥** | **$12,812** | **+14.08%** | âœ… **æœ€ä¼˜** |

### è¯¦ç»†æ”¶ç›Š

```
æ‰¹æ¬¡1: 0.4 BTC @ 98,280 = $2,912 (+8.00%)
æ‰¹æ¬¡2: 0.3 BTC @ 105,000 = $4,200 (+15.38%)
æ‰¹æ¬¡3: 0.3 BTC @ 110,000 = $5,700 (+20.88%)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»æ”¶ç›Š: $12,812 (+14.08%)
```

---

## ğŸ’¡ å®æˆ˜åº”ç”¨

### 1. å¼€ä»“æ¡ä»¶

```typescript
// å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶
if (
  signal.score >= 7 &&                    // é«˜è¯„åˆ†ä¿¡å·
  signal.direction !== 'NEUTRAL' &&       // æ–¹å‘æ˜ç¡®
  signal.confidence >= 0.7 &&             // é«˜ç½®ä¿¡åº¦
  anomaly.percent_change >= 3             // OIå˜åŒ– â‰¥ 3%
) {
  // å¯ä»¥å¼€ä»“
  const position_size = account_balance * 0.02; // å•ç¬” 2%
}
```

### 2. ä»“ä½è®¡ç®—

```typescript
// é€ä»“æ¨¡å¼ï¼šå¼€ä»“é‡‘é¢ = å¯æ¥å—çš„æœ€å¤§æŸå¤±
const account_balance = 100000; // $100,000
const risk_per_trade = 0.02;    // å•ç¬”é£é™© 2%

const max_position_value = account_balance * risk_per_trade;
// = $100,000 Ã— 2% = $2,000

// å¦‚æœ BTC ä»·æ ¼ = $91,000
const quantity = max_position_value / 91000;
// = $2,000 / $91,000 = 0.02198 BTC
```

### 3. è·Ÿè¸ªç®¡ç†

```typescript
import { TrailingStopManager } from './src/trading/trailing_stop_manager';

const trailing_manager = new TrailingStopManager();

// å¼€ä»“åç«‹å³å¼€å§‹è·Ÿè¸ª
trailing_manager.start_tracking(
  position_id,
  signal.symbol,
  PositionSide.LONG,
  entry_price,
  quantity,
  signal.dynamic_take_profit!
);

// å®æ—¶ä»·æ ¼æ›´æ–°ï¼ˆWebSocket æˆ–è½®è¯¢ï¼‰
ws.on('price_update', (data) => {
  const actions = trailing_manager.update_price(
    position_id,
    data.current_price
  );

  for (const action of actions) {
    if (action.type === 'BATCH_TAKE_PROFIT') {
      await execute_partial_close(action);
    } else if (action.type === 'TRAILING_STOP') {
      await execute_full_close(action);
    }
  }
});
```

---

## ğŸ”„ ä¸å…¨ä»“æ­¢æŸæ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | é€ä»“æ¨¡å¼ï¼ˆæœ¬ç­–ç•¥ï¼‰ | å…¨ä»“æ­¢æŸæ¨¡å¼ |
|------|-------------------|-------------|
| æ­¢æŸçº¿ | âŒ æ—  | âœ… -2% å›ºå®š |
| æœ€å¤§æŸå¤± | 100% æœ¬é‡‘ | 2% æœ¬é‡‘ |
| è¢«æ­¢æŸé£é™© | ä½ï¼ˆæ— æ­¢æŸï¼‰ | é«˜ï¼ˆçŸ­æœŸæ³¢åŠ¨ï¼‰ |
| é€‚ç”¨åœºæ™¯ | é«˜æ³¢åŠ¨ã€å¼ºä¿¡å· | ä½èƒœç‡ã€æ™®é€šä¿¡å· |
| å¿ƒç†å‹åŠ› | é«˜ï¼ˆå¯èƒ½å½’é›¶ï¼‰ | ä½ï¼ˆæŸå¤±å¯æ§ï¼‰ |
| æ•æ‰å¤§è¡Œæƒ…èƒ½åŠ› | æå¼º | ä¸€èˆ¬ |
| èµ„é‡‘åˆ©ç”¨ç‡ | ä½ï¼ˆ2%å•ç¬”ï¼‰ | ä¸­ï¼ˆ3-5%å•ç¬”ï¼‰ |

---

## ğŸ“ˆ æ•°å­¦æœŸæœ›åˆ†æ

### å‡è®¾æ¡ä»¶

- èƒœç‡ W = 30%
- ç¬¬1æ‰¹æ­¢ç›ˆç‡ R1 = 8%ï¼Œä»“ä½ P1 = 40%
- ç¬¬2æ‰¹æ­¢ç›ˆç‡ R2 = 14%ï¼Œä»“ä½ P2 = 30%
- ç¬¬3æ‰¹æ­¢ç›ˆç‡ R3 = 18%ï¼Œä»“ä½ P3 = 30% (å¹³å‡)
- æ­¢æŸç‡ L = -100% (é€ä»“å½’é›¶)

### æœŸæœ›æ”¶ç›Šè®¡ç®—

```
E = W Ã— (P1Ã—R1 + P2Ã—R2 + P3Ã—R3) - (1-W) Ã— L
  = 0.3 Ã— (0.4Ã—8% + 0.3Ã—14% + 0.3Ã—18%) - 0.7 Ã— 100%
  = 0.3 Ã— 11.8% - 70%
  = 3.54% - 70%
  = -66.46% âŒ
```

### âš ï¸ é‡è¦å‘ç°

**å•çº¯30%èƒœç‡ä¸‹ï¼ŒæœŸæœ›æ”¶ç›Šä¸ºè´Ÿï¼**

### è§£å†³æ–¹æ¡ˆ

1. **æé«˜èƒœç‡**
   - ä»…äº¤æ˜“é«˜è¯„åˆ†ä¿¡å· (â‰¥7åˆ†)
   - ä¸¥æ ¼è¿‡æ»¤èƒŒç¦»å’Œè¿‡çƒ­ä¿¡å·
   - **ç›®æ ‡èƒœç‡**: 45-50%

2. **æé«˜å¹³å‡æ”¶ç›Šç‡**
   - è·Ÿè¸ªæ­¢ç›ˆæ•æ‰æ›´å¤§è¡Œæƒ…
   - ç¬¬3æ‰¹å¹³å‡æ”¶ç›Šç‡æå‡è‡³ 25%+
   - **ç›®æ ‡å¹³å‡æ”¶ç›Š**: 15%+

3. **ä¼˜åŒ–ä»“ä½ç®¡ç†**
   - é™ä½å•ç¬”é£é™©è‡³ 1-2%
   - åˆ†æ•£æŒä»“ï¼Œé¿å…å•å¸ç§é‡ä»“

### ä¿®æ­£åæœŸæœ›ï¼ˆèƒœç‡ 50%ï¼Œå¹³å‡æ”¶ç›Š 15%ï¼‰

```
E = 0.5 Ã— 15% - 0.5 Ã— 100%
  = 7.5% - 50%
  = -42.5% âŒ ä»ä¸ºè´Ÿ
```

### âš ï¸ ç»“è®º

**é€ä»“æ— æ­¢æŸæ¨¡å¼å¿…é¡»æ»¡è¶³**:
```
èƒœç‡ Ã— å¹³å‡æ”¶ç›Šç‡ > (1 - èƒœç‡) Ã— 100%

æœ€ä½èƒœç‡è¦æ±‚:
- å¹³å‡æ”¶ç›Š 15%: èƒœç‡éœ€ â‰¥ 87%
- å¹³å‡æ”¶ç›Š 20%: èƒœç‡éœ€ â‰¥ 83%
- å¹³å‡æ”¶ç›Š 30%: èƒœç‡éœ€ â‰¥ 77%
```

**å®é™…å»ºè®®**:
- é€ä»“æ¨¡å¼é€‚åˆ**æå°‘æ•°é«˜ç¡®å®šæ€§æœºä¼š**
- æ—¥å¸¸äº¤æ˜“å»ºè®®ä½¿ç”¨ **-2% æ­¢æŸçš„å…¨ä»“æ¨¡å¼**
- æˆ–é‡‡ç”¨**æ··åˆç­–ç•¥**ï¼šé«˜è¯„åˆ†ç”¨é€ä»“ï¼Œä½è¯„åˆ†ç”¨å…¨ä»“

---

## ğŸš€ æœªæ¥ä¼˜åŒ–

### 1. åŠ¨æ€æ­¢æŸï¼ˆæ··åˆæ¨¡å¼ï¼‰

```typescript
// è¾¾åˆ°ç¬¬ä¸€æ‰¹æ­¢ç›ˆåï¼Œå°†æ•´ä½“æ­¢æŸæå‡è‡³ä¿æœ¬ä½
if (executed_targets >= 1) {
  stop_loss = entry_price; // ä¿æœ¬æ­¢æŸ
}

// è¾¾åˆ°ç¬¬äºŒæ‰¹æ­¢ç›ˆåï¼Œå°†æ•´ä½“æ­¢æŸæå‡è‡³ +5%
if (executed_targets >= 2) {
  stop_loss = entry_price * 1.05; // é”å®šåˆ©æ¶¦
}
```

### 2. æ™ºèƒ½ä»“ä½è°ƒæ•´

```typescript
// æ ¹æ®ä¿¡å·è¯„åˆ†åŠ¨æ€è°ƒæ•´ä»“ä½æ¯”ä¾‹
if (signal.score >= 9) {
  // æå¼ºä¿¡å·ï¼šæ›´æ¿€è¿›
  targets = [30%, 30%, 40%]; // æ›´å¤šè·Ÿè¸ªä»“ä½
} else if (signal.score >= 7) {
  // å¼ºä¿¡å·ï¼šæ ‡å‡†
  targets = [40%, 30%, 30%];
} else {
  // ä¸­ç­‰ä¿¡å·ï¼šä¿å®ˆ
  targets = [50%, 30%, 20%];
}
```

### 3. å¤šçº§è·Ÿè¸ªæ­¢ç›ˆ

```typescript
// ç¬¬ä¸‰æ‰¹åˆ†ä¸ºä¸¤æ®µè·Ÿè¸ª
targets = [
  { percentage: 40, price: entry * 1.08, is_trailing: false },
  { percentage: 30, price: entry * 1.14, is_trailing: false },
  { percentage: 15, price: 0, is_trailing: true, callback: 30% }, // ç¬¬ä¸€æ®µ
  { percentage: 15, price: 0, is_trailing: true, callback: 50% }  // ç¬¬äºŒæ®µï¼ˆæ›´æ¿€è¿›ï¼‰
];
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- [src/types/trading_types.ts](../src/types/trading_types.ts) - ç±»å‹å®šä¹‰
- [src/trading/signal_generator.ts](../src/trading/signal_generator.ts) - ä¿¡å·ç”Ÿæˆå™¨
- [src/trading/trailing_stop_manager.ts](../src/trading/trailing_stop_manager.ts) - è·Ÿè¸ªç®¡ç†å™¨
- [scripts/test_dynamic_take_profit.ts](../scripts/test_dynamic_take_profit.ts) - å®Œæ•´æµ‹è¯•

---

## âš ï¸ å…è´£å£°æ˜

**æœ¬ç­–ç•¥ä»…ä¾›å­¦ä¹ å’Œå‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚**

- åŠ å¯†è´§å¸å¸‚åœºæåº¦é«˜é£é™©
- é€ä»“æ— æ­¢æŸæ¨¡å¼å¯èƒ½å¯¼è‡´ 100% æœ¬é‡‘æŸå¤±
- è¯·åŠ¡å¿…ä½¿ç”¨å¯æ‰¿å—å…¨éƒ¨æŸå¤±çš„èµ„é‡‘
- å»ºè®®å…ˆåœ¨æ¨¡æ‹Ÿç¯å¢ƒå……åˆ†æµ‹è¯•
- å®ç›˜å‰è¯·å’¨è¯¢ä¸“ä¸šé‡‘èé¡¾é—®

---

**ç‰ˆæœ¬**: 2.0.0 (é€ä»“æ¨¡å¼)
**æ›´æ–°æ—¥æœŸ**: 2025-11-25
**ä½œè€…**: Trading System Team
